---
layout: default
title: '11G OCM Set up and configure Resource Manager'
base-url: home/11g-ocm/11g-ocm-performance-management/11g-ocm-set-up-and-configure-resource-manager.html
breadcrumbs:
- title: 'Home'
  url: index.html
- title: '11G OCM'
  url: home/11g-ocm.html
- title: '11G OCM Performance Management'
  url: home/11g-ocm/11g-ocm-performance-management.html
- title: '11G OCM Set up and configure Resource Manager'
  url: home/11g-ocm/11g-ocm-performance-management/11g-ocm-set-up-and-configure-resource-manager.html
table-of-contents:
- toc-url: References
  toc-text: References
- toc-url: Overview
  toc-text: Overview
- toc-url: The-MIXED_WORKLOAD_PLAN-Resource-Plan
  toc-text: The MIXED_WORKLOAD_PLAN Resource Plan
  toc-menu:
  - toc-url: Use-a-Sample-Plan
    toc-text: Use a Sample Plan
  - toc-url: Activate-Resource-Plans
    toc-text: Activate Resource Plans
  - toc-url: Ensure-that-MIXED_WORKLOAD_PLAN-Plan-is-Active
    toc-text: Ensure that MIXED_WORKLOAD_PLAN Plan is Active
- toc-url: Experiment-in-Switching
  toc-text: Experiment in Switching
  toc-menu:
  - toc-url: Change-the-Resource-Group-Mapping
    toc-text: Change the Resource Group Mapping
  - toc-url: Granting-Group-Switching-Rights
    toc-text: Granting Group Switching Rights
- toc-url: Running-the-Experiment-in-Group-Switching
  toc-text: Running the Experiment in Group Switching
  toc-menu:
  - toc-url: SQL-for-Experiment
    toc-text: SQL for Experiment
  - toc-url: Lower-Thresholds-for-Group-Switching
    toc-text: Lower Thresholds for Group Switching
  - toc-url: Result-of-Experiment
    toc-text: Result of Experiment
  - toc-url: Statistics-from-the-Experiment
    toc-text: Statistics from the Experiment
- toc-url: Cancel-the-SQL-If-It-Runs-Too-Long
  toc-text: Cancel the SQL If It Runs Too Long
  toc-menu:
  - toc-url: Update-Plan-Directive
    toc-text: Update Plan Directive
  - toc-url: Run-the-Experiment-Again
    toc-text: Run the Experiment Again
  - toc-url: Statistics-from-the-Experiment1
    toc-text: Statistics from the Experiment
- toc-url: Cancel-the-Session-If-the-SQL-Runs-Too-Long
  toc-text: Cancel the Session If the SQL Runs Too Long
  toc-menu:
  - toc-url: Update-Plan-Directive1
    toc-text: Update Plan Directive
  - toc-url: Performance-Problem
    toc-text: Performance Problem
  - toc-url: Run-the-Experiment-Again1
    toc-text: Run the Experiment Again
  - toc-url: Statistics-from-the-Experiment2
    toc-text: Statistics from the Experiment
- toc-url: Restore-Resource-Plan-to-Original-State
  toc-text: Restore Resource Plan to Original State
- toc-url: Conclusion
  toc-text: Conclusion
---
<div dir="ltr">
 <h3>
  <a name="TOC-1">
  </a>
  <br/>
 </h3>
 <h3>
  <a name="TOC-References">
  </a>
  References
 </h3>
 <p>
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/toc.htm" rel="nofollow">
   Oracle® Database Administrator's Guide 11g Release 1 (11.1)
  </a>
 </p>
 <ul compact="compact">
  <li>
   <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm.htm#i1010776" rel="nofollow">
    Chapter 25, "Managing Resource Allocation with Oracle Database Resource Manager"
   </a>
  </li>
  <ul compact="compact">
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm002.htm#i1007878" rel="nofollow">
     Creating a Simple Resource Plan
    </a>
   </li>
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm004.htm#i1008368" rel="nofollow">
     Assigning Sessions to Resource Consumer Groups
    </a>
   </li>
   <ul>
    <li>
     <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm004.htm#i1009363" rel="nofollow">
      Assigning an Initial Resource Consumer Group
     </a>
    </li>
    <li>
     <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm004.htm#i1008409" rel="nofollow">
      Granting and Revoking the Switch Privilege
     </a>
    </li>
   </ul>
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm005.htm#i1008488" rel="nofollow">
     Enabling Oracle Database Resource Manager and Switching Plans
    </a>
   </li>
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm006.htm" rel="nofollow">
     Putting It All Together: Oracle Database Resource Manager Examples
    </a>
   </li>
   <ul compact="compact">
    <li>
     <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm006.htm#i1008675" rel="nofollow">
      An Oracle-Supplied Mixed Workload Plan
     </a>
    </li>
   </ul>
  </ul>
 </ul>
 <p>
  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/toc.htm" rel="nofollow">
   Oracle® Database PL/SQL Packages and Types Reference 11g Release 1 (11.1)
  </a>
 </p>
 <ul compact="compact">
  <li>
   <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#CFAGGDBD" rel="nofollow">
    <code>
     DBMS_RESOURCE_MANAGER
    </code>
   </a>
  </li>
  <ul compact="compact">
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#CFAEHEHJ" rel="nofollow">
     <code>
      CREATE_PENDING_AREA
     </code>
    </a>
   </li>
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#i1004827" rel="nofollow">
     <code>
      SET_CONSUMER_GROUP_MAPPING
     </code>
    </a>
   </li>
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#CFABBJDH" rel="nofollow">
     <code>
      SUBMIT_PENDING_AREA
     </code>
    </a>
   </li>
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#i1003705" rel="nofollow">
     <code>
      UPDATE_PLAN_DIRECTIVE
     </code>
    </a>
   </li>
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#i1003620" rel="nofollow">
     <code>
      VALIDATE_PENDING_AREA
     </code>
    </a>
   </li>
  </ul>
  <li>
   <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmpr.htm#CFAGBGJE" rel="nofollow">
    <code>
     DBMS_RESOURCE_MANAGER_PRIVS
    </code>
   </a>
  </li>
  <ul compact="compact">
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmpr.htm#i999133" rel="nofollow">
     <code>
      GRANT_SWITCH_CONSUMER_GROUP
     </code>
    </a>
   </li>
  </ul>
  <li>
   <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_sessio.htm#BHCCFGIF" rel="nofollow">
    <code>
     DBMS_SESSION
    </code>
   </a>
  </li>
  <ul compact="compact">
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_sessio.htm#i997666" rel="nofollow">
     <code>
      SWITCH_CURRENT_CONSUMER_GROUP
     </code>
    </a>
   </li>
  </ul>
 </ul>
 <p>
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/toc.htm" rel="nofollow">
   Oracle® Database Reference 11g Release 1 (11.1)
  </a>
 </p>
 <ul compact="compact">
  <li>
   <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/initparams_part.htm#i200948" rel="nofollow">
    Part I Initialization Parameters
   </a>
  </li>
  <ul compact="compact">
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/initparams204.htm#CHDIGGIG" rel="nofollow">
     <code>
      RESOURCE_MANAGER_PLAN
     </code>
    </a>
   </li>
  </ul>
  <li>
   <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/statviews_part.htm#i125539" rel="nofollow">
    Part II Static Data Dictionary Views
   </a>
  </li>
  <ul compact="compact">
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/statviews_5073.htm#i1628672" rel="nofollow">
     <code>
      DBA_USERS
     </code>
    </a>
   </li>
  </ul>
  <li>
   <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_part.htm#i403961" rel="nofollow">
    Part III Dynamic Performance Views
   </a>
  </li>
  <ul compact="compact">
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_2147.htm#I1030402" rel="nofollow">
     <code>
      V$RSRC_CONS_GROUP_HISTORY
     </code>
    </a>
   </li>
   <li>
    <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_2150.htm#i1413789" rel="nofollow">
     <code>
      V$RSRC_PLAN
     </code>
    </a>
   </li>
  </ul>
 </ul>
 <h3>
  <a name="TOC-Overview">
  </a>
  Overview
 </h3>
 <p>
  The OCM 11G Upgrade Objective is:
 </p>
 <blockquote>
  <p>
   Set up and configure Resource Manager to control active sessions, number of I/Os, execution time..etc
  </p>
 </blockquote>
 <p>
  My reading of this and the experience of the 11G exam leads me to say that there are several possible sub-tasks:
 </p>
 <ol compact="compact">
  <li>
   Set up Resource Manager
  </li>
  <li>
   Configure Resource Plans to allocate CPU resources
  </li>
  <li>
   Control Active Sessions through
  </li>
  <ol compact="compact">
   <li>
    Assigning them to Resource Groups
   </li>
   <li>
    Switching between Resource Groups
   </li>
   <li>
    Killing the session once resource limits have been exceeded
   </li>
   <li>
    Killing the SQL once resource limits have been exceeded
   </li>
  </ol>
 </ol>
 <h3>
  <a name="TOC-The-MIXED_WORKLOAD_PLAN-Resource-Plan">
  </a>
  The MIXED_WORKLOAD_PLAN Resource Plan
 </h3>
 <h4>
  <a name="TOC-Use-a-Sample-Plan">
  </a>
  Use a Sample Plan
 </h4>
 <p>
  Rather than create a resource plan from scratch, I used a sample predefined plan called
  <code>
   MIXED_WORKLOAD_PLAN
  </code>
  from
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm006.htm#i1008675" rel="nofollow">
   An Oracle-Supplied Mixed Workload Plan
  </a>
  .
 </p>
 <p>
  Although it would be nice to go through the agony of creating a new resource plan via PL/SQL, I think that the OEM interface is sufficiently robust to create a resource plan painlessly.
 </p>
 <h4>
  <a name="TOC-Activate-Resource-Plans">
  </a>
  Activate Resource Plans
 </h4>
 <p>
  According to
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm005.htm#i1008488" rel="nofollow">
   Enabling Oracle Database Resource Manager and Switching Plans
  </a>
  , the system parameter,
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/initparams204.htm#CHDIGGIG" rel="nofollow">
   <code>
    RESOURCE_MANAGER_PLAN
   </code>
  </a>
  , needs to be set to a valid plan in order for Resource Plans to work:
 </p>
 <pre>ALTER SYSTEM SET RESOURCE_MANAGER_PLAN = MIXED_WORKLOAD_PLAN SCOPE = BOTH;
</pre>
 <h4>
  <a name="TOC-Ensure-that-MIXED_WORKLOAD_PLAN-Plan-is-Active">
  </a>
  Ensure that MIXED_WORKLOAD_PLAN Plan is Active
 </h4>
 <p>
  The current active plan can be determined in one of two (2) ways. The first is to query the dynamic view,
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_2150.htm#i1413789" rel="nofollow">
   <code>
    V$RSRC_PLAN
   </code>
  </a>
  , to see what the top plan is:
 </p>
 <pre>SQL&gt; SELECT * FROM v$rsrc_plan;
</pre>
 <table align="center" border="1" width="90%">
  <thead>
   <tr>
    <th>
     ID
    </th>
    <th>
     NAME
    </th>
    <th>
     IS_TOP_PLAN
    </th>
    <th>
     CPU_MANAGED
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td align="right">
     11187
    </td>
    <td>
     DEFAULT_MAINTENANCE_PLAN
    </td>
    <td>
     TRUE
    </td>
    <td>
     ON
    </td>
   </tr>
   <tr>
    <td align="right">
     11185
    </td>
    <td>
     ORA$AUTOTASK_SUB_PLAN
    </td>
    <td>
     FALSE
    </td>
    <td>
     ON
    </td>
   </tr>
   <tr>
    <td align="right">
     11186
    </td>
    <td>
     ORA$AUTOTASK_HIGH_SUB_PLAN
    </td>
    <td>
     FALSE
    </td>
    <td>
     ON
    </td>
   </tr>
  </tbody>
 </table>
 <p>
  Or, by the system parameter,
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/initparams204.htm#CHDIGGIG" rel="nofollow">
   <code>
    RESOURCE_MANAGER_PLAN
   </code>
  </a>
  ,
 </p>
 <pre>SQL&gt; show parameter resource_manager_plan
</pre>
 <table align="center" border="1" width="90%">
  <thead>
   <tr>
    <th>
     NAME
    </th>
    <th>
     TYPE
    </th>
    <th>
     VALUE
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     resource_manager_plan
    </td>
    <td>
     string
    </td>
    <td>
     MIXED_WORKLOAD_PLAN
    </td>
   </tr>
  </tbody>
 </table>
 <p>
  Or, if the maintenance window is currently active, the output is:
 </p>
 <table align="center" border="1" width="90%">
  <thead>
   <tr>
    <th>
     NAME
    </th>
    <th>
     TYPE
    </th>
    <th>
     VALUE
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     resource_manager_plan
    </td>
    <td>
     string
    </td>
    <td>
     SCHEDULER[0x2C0B]:DEFAULT_MAINTENANCE_PLAN
    </td>
   </tr>
  </tbody>
 </table>
 <h3>
  <a name="TOC-Experiment-in-Switching">
  </a>
  Experiment in Switching
 </h3>
 <p>
  I want to see the switching between resource groups in action. The chosen resource plan,
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm006.htm#i1008675" rel="nofollow">
   <code>
    MIXED_WORKLOAD_PLAN
   </code>
  </a>
  , switches between the
  <code>
   INTERACTIVE_GROUP
  </code>
  and the
  <code>
   BATCH_GROUP
  </code>
  when limits are exceeded.
 </p>
 <p>
  The following SQL is a resource hog:
 </p>
 <pre>select sum( dbms_random.value() ) from dual connect by level &lt; 10000000;
</pre>
 <p>
  The obvious user is
  <code>
   SH
  </code>
  who will need access to the following groups:
 </p>
 <ol compact="compact">
  <li>
   <code>
    INTERACTIVE_GROUP
   </code>
   and;
  </li>
  <li>
   <code>
    BATCH_GROUP
   </code>
  </li>
 </ol>
 <h4>
  <a name="TOC-Change-the-Resource-Group-Mapping">
  </a>
  Change the Resource Group Mapping
 </h4>
 <p>
  Initially, the user,
  <code>
   SH
  </code>
  , is mapped to the
  <code>
   DEFAULT_CONSUMER_GROUP
  </code>
  :
 </p>
 <pre>SQL&gt; SELECT username, initial_rsrc_consumer_group FROM dba_users WHERE username = 'SH';
</pre>
 <table align="center" border="1">
  <thead>
   <tr>
    <th>
     USERNAME
    </th>
    <th>
     INITIAL_RSRC_CONSUMER_GROUP
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     SH
    </td>
    <td>
     DEFAULT_CONSUMER_GROUP
    </td>
   </tr>
  </tbody>
 </table>
 <p>
  Since the resource plan,
  <code>
   MIXED_WORKLOAD_PLAN
  </code>
  , does not mention the group,
  <code>
   DEFAULT_CONSUMER_GROUP
  </code>
  , explictly, users in this group are mapped to the rule for
  <code>
   OTHER_GROUPS
  </code>
  in the plan.
 </p>
 <p>
  Instead of running in the
  <code>
   OTHER_GROUPS
  </code>
  , the user,
  <code>
   SH
  </code>
  , will be mapped to the
  <code>
   INTERACTIVE_GROUP
  </code>
  and thereby be affected by possible group switching. This is done through the
  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#i1004827" rel="nofollow">
   <code>
    SET_CONSUMER_GROUP_MAPPING
   </code>
  </a>
  procedure:
 </p>
 <pre>BEGIN
    dbms_resource_manager.clear_pending_area();
    dbms_resource_manager.create_pending_area();
    dbms_resource_manager.set_consumer_group_mapping(
        dbms_resource_manager.oracle_user,
        'SH',
        'INTERACTIVE_GROUP'
    );
    dbms_resource_manager.submit_pending_area();
END;
</pre>
 <p>
  Checking the initial resource consumer group is now correct via the
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/statviews_5073.htm#i1628672" rel="nofollow">
   <code>
    DBA_USERS
   </code>
  </a>
  view:
 </p>
 <pre>SQL&gt; SELECT username, initial_rsrc_consumer_group FROM dba_users WHERE username = 'SH';
</pre>
 <table align="center" border="1">
  <thead>
   <tr>
    <th>
     USERNAME
    </th>
    <th>
     INITIAL_RSRC_CONSUMER_GROUP
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     SH
    </td>
    <td>
     INTERACTIVE_GROUP
    </td>
   </tr>
  </tbody>
 </table>
 <p>
  The user,
  <code>
   SH
  </code>
  , has to be granted access to the following groups:
 </p>
 <ol compact="compact">
  <li>
   <code>
    INTERACTIVE_GROUP
   </code>
   ; and
  </li>
  <li>
   <code>
    BATCH_GROUP
   </code>
   .
  </li>
 </ol>
 <p>
  Without giving the permission to switch into the
  <code>
   BATCH_GROUP
  </code>
  , we get an error as follows when I try using the
  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_sessio.htm#i997666" rel="nofollow">
   <code>
    SWITCH_CURRENT_CONSUMER_GROUP
   </code>
  </a>
  procedure:
 </p>
 <pre>SQL&gt; connect sh/sh
Connected.
SQL&gt; VARIABLE old_consumer_group VARCHAR2(32)
SQL&gt; EXEC DBMS_SESSION.switch_current_consumer_group( 'BATCH_GROUP', :old_consumer_group, TRUE )
Attempting to switch to BATCH_GROUP from current group
BEGIN DBMS_SESSION.switch_current_consumer_group( 'BATCH_GROUP', :old_consumer_group, TRUE ); END;

*
ERROR at line 1:
ORA-01031: insufficient privileges
ORA-06512: at "SYS.DBMS_SESSION", line 130
ORA-06512: at line 1
</pre>
 <h4>
  <a name="TOC-Granting-Group-Switching-Rights">
  </a>
  Granting Group Switching Rights
 </h4>
 <p>
  According to
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28310/dbrm004.htm#i1008409" rel="nofollow">
   Granting and Revoking the Switch Privilege
  </a>
  ,:
 </p>
 <blockquote>
  <p>
   Using the
   <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmpr.htm#CFAGBGJE" rel="nofollow">
    <code>
     DBMS_RESOURCE_MANAGER_PRIVS
    </code>
   </a>
   PL/SQL package, you can grant or revoke the switch privilege to a user, role, or PUBLIC. The switch privilege enables a user or application to switch a session to a specified resource consumer group.
   <span style="font-weight:bold">
    It also enables the database to automatically switch a session to a consumer group specified in a session-to–consumer group mapping rule or specified in the SWITCH_GROUP parameter of a resource plan directive.
   </span>
  </p>
  <p style="text-align:right;font-weight:bold">
   Emphasis Mine
  </p>
 </blockquote>
 <p>
  Thus, I need to grant the privilege to switch into the target groups to the
  <code>
   SH
  </code>
  user through the
  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmpr.htm#i999133" rel="nofollow">
   GRANT_SWITCH_CONSUMER_GROUP Procedure
  </a>
  procedure as follows:
 </p>
 <pre>BEGIN
  dbms_resource_manager_privs.grant_switch_consumer_group( 'SH', 'INTERACTIVE_GROUP', FALSE );
  dbms_resource_manager_privs.grant_switch_consumer_group( 'SH', 'BATCH_GROUP', FALSE );
END;
/
</pre>
 <p>
  Now, I test the ability of the
  <code>
   SH
  </code>
  user to switch between groups by again using the
  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_sessio.htm#i997666" rel="nofollow">
   <code>
    SWITCH_CURRENT_CONSUMER_GROUP
   </code>
  </a>
  procedure:
 </p>
 <pre>SQL&gt; connect sh/sh
Connected.
SQL&gt; select initial_rsrc_consumer_group from user_users;

INITIAL_RSRC_CONSUMER_GROUP
------------------------------
INTERACTIVE_GROUP

SQL&gt; VARIABLE old_consumer_group VARCHAR2(32)
SQL&gt; exec DBMS_SESSION.switch_current_consumer_group( 'BATCH_GROUP', :old_consumer_group, TRUE )

PL/SQL procedure successfully completed.

SQL&gt; print old_consumer_group

OLD_CONSUMER_GROUP
--------------------------------------------------------------------------------


SQL&gt; exec DBMS_SESSION.switch_current_consumer_group( 'BATCH_GROUP', :old_consumer_group, TRUE )

PL/SQL procedure successfully completed.

SQL&gt; print old_consumer_group

OLD_CONSUMER_GROUP
--------------------------------------------------------------------------------


SQL&gt; exec DBMS_SESSION.switch_current_consumer_group( 'INTERACTIVE_GROUP', :old_consumer_group, TRUE )

PL/SQL procedure successfully completed.

SQL&gt; print old_consumer_group

OLD_CONSUMER_GROUP
--------------------------------------------------------------------------------
BATCH_GROUP
</pre>
 <p>
  <span style="font-weight:bold">
   Note:
  </span>
  The first switch says that the old consumer group is NULL even though the initial resource consumer group is not.
 </p>
 <h3>
  <a name="TOC-Running-the-Experiment-in-Group-Switching">
  </a>
  Running the Experiment in Group Switching
 </h3>
 <h4>
  <a name="TOC-SQL-for-Experiment">
  </a>
  SQL for Experiment
 </h4>
 <p>
  The SQL to be tested is a guaranteed CPU hog:
 </p>
 <pre>select sum( dbms_random.value() ) from dual connect by level &lt; 10000000;
</pre>
 <h4>
  <a name="TOC-Lower-Thresholds-for-Group-Switching">
  </a>
  Lower Thresholds for Group Switching
 </h4>
 <p>
  The supplied resource plan,
  <code>
   MIXED_WORKLOAD_PLAN
  </code>
  , switches to
  <code>
   BATCH_GROUP
  </code>
  after 60 seconds of CPU. I want to lower the switching threshold to five (5) CPU seconds by using
  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#i1003705" rel="nofollow">
   <code>
    UPDATE_PLAN_DIRECTIVE
   </code>
  </a>
  procedure:
 </p>
 <pre>BEGIN
  DBMS_RESOURCE_MANAGER.CREATE_PENDING_AREA;
  DBMS_RESOURCE_MANAGER.UPDATE_PLAN_DIRECTIVE (
     plan                          =&gt; 'MIXED_WORKLOAD_PLAN', 
     group_or_subplan              =&gt; 'INTERACTIVE_GROUP', 
     new_switch_time               =&gt; 5,
     new_switch_for_call           =&gt; TRUE); 
  DBMS_RESOURCE_MANAGER.VALIDATE_PENDING_AREA;
  DBMS_RESOURCE_MANAGER.SUBMIT_PENDING_AREA;
END;
/
</pre>
 <h4>
  <a name="TOC-Result-of-Experiment">
  </a>
  Result of Experiment
 </h4>
 <p>
  Confimed that the
  <code>
   SH
  </code>
  user is in the correct initial resource group:
 </p>
 <pre>select resource_consumer_group from v$session where username = 'SH';
</pre>
 <table align="center" border="1">
  <thead>
   <tr>
    <th>
     RESOURCE_CONSUMER_GROUP
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     INTERACTIVE_GROUP
    </td>
   </tr>
  </tbody>
 </table>
 <p>
  Run the SQL:
 </p>
 <pre>SQL&gt; select sum( dbms_random.value() ) from dual connect by level &lt; 10000000;

SUM(DBMS_RANDOM.VALUE())
------------------------
              4998828.87

Elapsed: 00:01:58.72
</pre>
 <h4>
  <a name="TOC-Statistics-from-the-Experiment">
  </a>
  Statistics from the Experiment
 </h4>
 <p>
  The data from the dynamic view,
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_2147.htm#I1030402" rel="nofollow">
   <code>
    V$RSRC_CONS_GROUP_HISTORY
   </code>
  </a>
  , shows the group switching having occurred because the SQL exceeded the CPU quantum:
 </p>
 <pre>SELECT
    name,
    requests,
    consumed_cpu_time,
    switches_in_cpu_time,
    switches_out_cpu_time,
    sql_canceled,
    active_sess_killed
  FROM
    v$rsrc_cons_group_history
  WHERE
      sequence# =
        (SELECT MAX(sequence#) FROM V$RSRC_CONS_GROUP_HISTORY)
    AND name NOT LIKE 'ORA%'
    AND name &lt;&gt; '_ORACLE_BACKGROUND_GROUP_'
  ORDER BY name;
</pre>
 <table align="center" border="1" width="90%">
  <thead>
   <tr>
    <th>
     NAME
    </th>
    <th>
     REQUESTS
    </th>
    <th>
     CONSUMED_CPU_TIME
    </th>
    <th>
     SWITCHES_IN_CPU_TIME
    </th>
    <th>
     SWITCHES_OUT_CPU_TIME
    </th>
    <th>
     SQL_CANCELED
    </th>
    <th>
     ACTIVE_SESS_KILLED
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     BATCH_GROUP
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     6168608
    </td>
    <td align="right">
     2
    </td>
    <td align="right">
     1
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
   <tr>
    <td>
     INTERACTIVE_GROUP
    </td>
    <td align="right">
     2
    </td>
    <td align="right">
     9890216
    </td>
    <td align="right">
     1
    </td>
    <td align="right">
     2
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
   <tr>
    <td>
     OTHER_GROUPS
    </td>
    <td align="right">
     26
    </td>
    <td align="right">
     16677997
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
   <tr>
    <td>
     SYS_GROUP
    </td>
    <td align="right">
     5
    </td>
    <td align="right">
     6277055
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
  </tbody>
 </table>
 <p>
  Here we see two (2) switches out of the
  <code>
   INTERACTIVE_GROUP
  </code>
  and one (1) switch back in due to CPU threshold. And the reverse is true for the
  <code>
   BATCH_GROUP
  </code>
  . It would appear that the switch from
  <code>
   BATCH_GROUP
  </code>
  to
  <code>
   INTERACTIVE_GROUP
  </code>
  is due to the
  <code>
   SWITCH_AFTER_CALL
  </code>
  flag in the resource plan directive.
 </p>
 <p>
  We confirm the resource consumer group after the call is back to the original:
 </p>
 <pre>SQL&gt; select resource_consumer_group from v$session where username = 'SH';
</pre>
 <table align="center" border="1">
  <thead>
   <tr>
    <th>
     RESOURCE_CONSUMER_GROUP
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     INTERACTIVE_GROUP
    </td>
   </tr>
  </tbody>
 </table>
 <h3>
  <a name="TOC-Cancel-the-SQL-If-It-Runs-Too-Long">
  </a>
  Cancel the SQL If It Runs Too Long
 </h3>
 <h4>
  <a name="TOC-Update-Plan-Directive">
  </a>
  Update Plan Directive
 </h4>
 <p>
  To cancel the SQL statement after running for more than five (5) CPU seconds, the
  <code>
   MIXED_WORKLOAD_PLAN
  </code>
  plan is updated to set the
  <code>
   NEW_SWITCH_GROUP
  </code>
  to
  <code>
   CANCEL_SQL
  </code>
  via the
  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#i1003705" rel="nofollow">
   <code>
    UPDATE_PLAN_DIRECTIVE
   </code>
  </a>
  procedure:
 </p>
 <pre>BEGIN
  DBMS_RESOURCE_MANAGER.CREATE_PENDING_AREA;
  DBMS_RESOURCE_MANAGER.UPDATE_PLAN_DIRECTIVE (
     plan                          =&gt; 'MIXED_WORKLOAD_PLAN', 
     group_or_subplan              =&gt; 'INTERACTIVE_GROUP', 
     new_switch_time               =&gt; 5,
     new_switch_group              =&gt; 'CANCEL_SQL'); 
  DBMS_RESOURCE_MANAGER.VALIDATE_PENDING_AREA;
  DBMS_RESOURCE_MANAGER.SUBMIT_PENDING_AREA;
END;
/
</pre>
 <h4>
  <a name="TOC-Run-the-Experiment-Again">
  </a>
  Run the Experiment Again
 </h4>
 <p>
  The same SQL is used again with the following results:
 </p>
 <pre>SQL&gt; select sum( dbms_random.value() ) from dual connect by level &lt; 10000000;
select sum( dbms_random.value() ) from dual connect by level &lt; 10000000
            *
ERROR at line 1:
ORA-00040: active time limit exceeded - call aborted


Elapsed: 00:00:05.30
</pre>
 <h4>
  <a name="TOC-Statistics-from-the-Experiment1">
  </a>
  Statistics from the Experiment
 </h4>
 <p>
  The data from the dynamic view,
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_2147.htm#I1030402" rel="nofollow">
   <code>
    V$RSRC_CONS_GROUP_HISTORY
   </code>
  </a>
  , shows the group switching having occurred because the SQL exceeded the CPU quantum:
 </p>
 <pre>SELECT
    name,
    requests,
    consumed_cpu_time,
    switches_in_cpu_time,
    switches_out_cpu_time,
    sql_canceled,
    active_sess_killed
  FROM
    v$rsrc_cons_group_history
  WHERE
      sequence# =
        (SELECT MAX(sequence#) FROM V$RSRC_CONS_GROUP_HISTORY)
    AND name NOT LIKE 'ORA%'
    AND name &lt;&gt; '_ORACLE_BACKGROUND_GROUP_'
  ORDER BY name;
</pre>
 <table align="center" border="1" width="90%">
  <thead>
   <tr>
    <th>
     NAME
    </th>
    <th>
     REQUESTS
    </th>
    <th>
     CONSUMED_CPU_TIME
    </th>
    <th>
     SWITCHES_IN_CPU_TIME
    </th>
    <th>
     SWITCHES_OUT_CPU_TIME
    </th>
    <th>
     SQL_CANCELED
    </th>
    <th>
     ACTIVE_SESS_KILLED
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     BATCH_GROUP
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
   <tr>
    <td>
     INTERACTIVE_GROUP
    </td>
    <td align="right">
     1
    </td>
    <td align="right">
     1765545
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     1
    </td>
    <td align="right">
     0
    </td>
   </tr>
   <tr>
    <td>
     OTHER_GROUPS
    </td>
    <td align="right">
     4
    </td>
    <td align="right">
     92
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
   <tr>
    <td>
     SYS_GROUP
    </td>
    <td align="right">
     3
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
  </tbody>
 </table>
 <p>
  This shows that the statistics are reset (actually given a new
  <code>
   SEQUENCE#
  </code>
  ) whenever the resource plan is updated.
 </p>
 <p>
  Here we see the SQL being cancelled is being recorded for the
  <code>
   INTERACTIVE_GROUP
  </code>
  .
 </p>
 <p>
  I cannot make sense of the
  <code>
   CONSUMED_CPU_TIME
  </code>
  value.
 </p>
 <h3>
  <a name="TOC-Cancel-the-Session-If-the-SQL-Runs-Too-Long">
  </a>
  Cancel the Session If the SQL Runs Too Long
 </h3>
 <h4>
  <a name="TOC-Update-Plan-Directive1">
  </a>
  Update Plan Directive
 </h4>
 <p>
  To cancel the session whenever the SQL statement after running for more than five (5) CPU seconds, the
  <code>
   MIXED_WORKLOAD_PLAN
  </code>
  plan is updated to set the
  <code>
   NEW_SWITCH_GROUP
  </code>
  to
  <code>
   KILL_SESSION
  </code>
  via the
  <a href="http://docs.oracle.com/cd/B28359_01/appdev.111/b28419/d_resmgr.htm#i1003705" rel="nofollow">
   <code>
    UPDATE_PLAN_DIRECTIVE
   </code>
  </a>
  procedure:
 </p>
 <pre>BEGIN
  DBMS_RESOURCE_MANAGER.CREATE_PENDING_AREA;
  DBMS_RESOURCE_MANAGER.UPDATE_PLAN_DIRECTIVE (
     plan                          =&gt; 'MIXED_WORKLOAD_PLAN', 
     group_or_subplan              =&gt; 'INTERACTIVE_GROUP', 
     new_switch_time               =&gt; 5,
     new_switch_group              =&gt; 'KILL_SESSION'); 
  DBMS_RESOURCE_MANAGER.VALIDATE_PENDING_AREA;
  DBMS_RESOURCE_MANAGER.SUBMIT_PENDING_AREA;
END;
/
</pre>
 <h4>
  <a name="TOC-Performance-Problem">
  </a>
  Performance Problem
 </h4>
 <p>
  This change in Resource Plan Directive took a very long time (about 40 minutes to complete). The OEM top activity showed the following graph:
 </p>
 <div style="display:block;text-align:left">
  <img border="0" src="home/11g-ocm/11g-ocm-performance-management/11g-ocm-set-up-and-configure-resource-manager/GC.png"/>
 </div>
 <p>
  The ASH report for the period, 03:10 to 03:50, is attached as
  <code>
   <a href="home/11g-ocm/11g-ocm-performance-management/11g-ocm-set-up-and-configure-resource-manager/ASH_report_1327656054538.html">
    ASH_report_1327656054538.html
   </a>
  </code>
  . The Top User Events were:
 </p>
 <table border="1">
  <tbody>
   <tr>
    <th style="font:bold 8pt Arial,Helvetica,Geneva,sans-serif;color:White;background:#0066cc;padding-left:4px;padding-right:4px;padding-bottom:2px">
     Event
    </th>
    <th style="font:bold 8pt Arial,Helvetica,Geneva,sans-serif;color:White;background:#0066cc;padding-left:4px;padding-right:4px;padding-bottom:2px">
     Event Class
    </th>
    <th style="font:bold 8pt Arial,Helvetica,Geneva,sans-serif;color:White;background:#0066cc;padding-left:4px;padding-right:4px;padding-bottom:2px">
     % Event
    </th>
    <th style="font:bold 8pt Arial,Helvetica,Geneva,sans-serif;color:White;background:#0066cc;padding-left:4px;padding-right:4px;padding-bottom:2px">
     Avg Active Sessions
    </th>
   </tr>
   <tr>
    <td style="font:8pt Arial,Helvetica,Geneva,sans-serif;color:black;background:#ffffcc;vertical-align:top">
     resmgr:cpu quantum
    </td>
    <td style="font:8pt Arial,Helvetica,Geneva,sans-serif;color:black;background:#ffffcc;vertical-align:top">
     Scheduler
    </td>
    <td align="right" style="font:8pt Arial,Helvetica,Geneva,sans-serif;color:black;background:#ffffcc;vertical-align:top">
     99.05
    </td>
    <td align="right" style="font:8pt Arial,Helvetica,Geneva,sans-serif;color:black;background:#ffffcc;vertical-align:top">
     3.48
    </td>
   </tr>
  </tbody>
 </table>
 <h4>
  <a name="TOC-Run-the-Experiment-Again1">
  </a>
  Run the Experiment Again
 </h4>
 <p>
  The same SQL is used again with the following results:
 </p>
 <pre>SQL&gt; select sum( dbms_random.value() ) from dual connect by level &lt; 10000000;
select sum( dbms_random.value() ) from dual connect by level &lt; 10000000
*
ERROR at line 1:
ORA-00041: active time limit exceeded - session terminated


Elapsed: 00:00:05.80
</pre>
 <h4>
  <a name="TOC-Statistics-from-the-Experiment2">
  </a>
  Statistics from the Experiment
 </h4>
 <p>
  The data from the dynamic view,
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_2147.htm#I1030402" rel="nofollow">
   <code>
    V$RSRC_CONS_GROUP_HISTORY
   </code>
  </a>
  , shows the group switching having occurred because the SQL exceeded the CPU quantum:
 </p>
 <pre>SELECT
    name,
    requests,
    consumed_cpu_time,
    switches_in_cpu_time,
    switches_out_cpu_time,
    sql_canceled,
    active_sess_killed
  FROM
    v$rsrc_cons_group_history
  WHERE
      sequence# =
        (SELECT MAX(sequence#) FROM V$RSRC_CONS_GROUP_HISTORY)
    AND name NOT LIKE 'ORA%'
    AND name &lt;&gt; '_ORACLE_BACKGROUND_GROUP_'
  ORDER BY name;
</pre>
 <table align="center" border="1" width="90%">
  <thead>
   <tr>
    <th>
     NAME
    </th>
    <th>
     REQUESTS
    </th>
    <th>
     CONSUMED_CPU_TIME
    </th>
    <th>
     SWITCHES_IN_CPU_TIME
    </th>
    <th>
     SWITCHES_OUT_CPU_TIME
    </th>
    <th>
     SQL_CANCELED
    </th>
    <th>
     ACTIVE_SESS_KILLED
    </th>
   </tr>
  </thead>
  <tbody>
   <tr>
    <td>
     BATCH_GROUP
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
   <tr>
    <td>
     INTERACTIVE_GROUP
    </td>
    <td align="right">
     1
    </td>
    <td align="right">
     3974203
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     1
    </td>
   </tr>
   <tr>
    <td>
     OTHER_GROUPS
    </td>
    <td align="right">
     9
    </td>
    <td align="right">
     6086496
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
   <tr>
    <td>
     SYS_GROUP
    </td>
    <td align="right">
     6
    </td>
    <td align="right">
     5355213
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
    <td align="right">
     0
    </td>
   </tr>
  </tbody>
 </table>
 <p>
  And we see the statistic,
  <code>
   ACTIVE_SESS_KILLED
  </code>
  , has a value of one (1) for when the session was killed.
 </p>
 <h3>
  <a name="TOC-Restore-Resource-Plan-to-Original-State">
  </a>
  Restore Resource Plan to Original State
 </h3>
 <p>
  Used the following SQL to restore the
  <code>
   MIXED_WORKLOAD_PLAN
  </code>
  plan back to its original state:
 </p>
 <pre>BEGIN
  DBMS_RESOURCE_MANAGER.CREATE_PENDING_AREA;
  DBMS_RESOURCE_MANAGER.UPDATE_PLAN_DIRECTIVE (
     plan                          =&gt; 'MIXED_WORKLOAD_PLAN', 
     group_or_subplan              =&gt; 'INTERACTIVE_GROUP', 
     new_switch_time               =&gt; 60,
     new_switch_group              =&gt; 'BATCH_GROUP',
     new_switch_for_call           =&gt; TRUE); 
  DBMS_RESOURCE_MANAGER.VALIDATE_PENDING_AREA;
  DBMS_RESOURCE_MANAGER.SUBMIT_PENDING_AREA;
END;
/
</pre>
 <h3>
  <a name="TOC-Conclusion">
  </a>
  Conclusion
 </h3>
 <p>
  This demonstration of the Resource Manager is far in excess of what is expected on the OCM 11G upgrade exam, but I wanted to explore as much as possible. I have demonstrated:
 </p>
 <ul compact="compact">
  <li>
   Switching between groups
  </li>
  <li>
   Killing the SQL
  </li>
  <li>
   Killing the Session
  </li>
 </ul>
 <p>
  This was only done for CPU.
 </p>
 <p>
  The performance of the plan updating is problematic. Probably a bug in Oracle RDBMS 11.1.0.6.
 </p>
 <p>
  The values displayed in
  <code>
   CONSUMED_CPU_TIME
  </code>
  of the
  <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28320/dynviews_2147.htm#I1030402" rel="nofollow">
   <code>
    V$RSRC_CONS_GROUP_HISTORY
   </code>
  </a>
  dynamic view do not make any sense.
 </p>
</div>
