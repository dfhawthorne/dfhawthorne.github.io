---
layout: default
title: '2018-03-15 Ansible Roles'
base-url: home/system-builds/redfern/2018-03-15-ansible-roles.html
breadcrumbs:
- title: 'Home'
  url: index.html
- title: 'System Builds'
  url: home/system-builds.html
- title: 'REDFERN'
  url: home/system-builds/redfern.html
- title: '2018-03-15 Ansible Roles'
  url: home/system-builds/redfern/2018-03-15-ansible-roles.html
scroll-bar:
  left-link:
    url: home/system-builds/redfern/2018-03-14-ansible-playbook-for-software-nfs.html
    title: '2018-03-14 Ansible Playbook for Software NFS'
  right-link:
    url: home/system-builds/redfern/2018-03-17-ansible-playbook-to-install-gi-software.html
    title: '2018-03-17 Ansible Playbook to Install GI Software'
table-of-contents:
- toc-url: 'Overview'
  toc-text: 'Overview'
- toc-url: 'References'
  toc-text: 'References'
- toc-url: 'Design'
  toc-text: 'Design'
  toc-menu:
  - toc-url: 'Roles-Selected'
    toc-text: 'Roles Selected'
- toc-url: 'Procedure'
  toc-text: 'Procedure'
  toc-menu:
  - toc-url: 'Create-Roles'
    toc-text: 'Create Roles'
  - toc-url: 'Playbook-for-Oracle-User-Role'
    toc-text: 'Playbook for Oracle User Role'
  - toc-url: 'Playbook-for-Oracle-GI-Role'
    toc-text: 'Playbook for Oracle GI Role'
  - toc-url: 'Main-Playbook'
    toc-text: 'Main Playbook'
  - toc-url: 'Execute-Main-Playbook'
    toc-text: 'Execute Main Playbook'
---

<!-- {% raw %} -->
<div dir="ltr">

<br/>

<br/>
<h2>
<a name="TOC-Overview">
</a>
                    Overview
                   </h2>
<p>
                    I have accumulated several Ansible
                    <a href="http://docs.ansible.com/ansible/latest/playbooks.html" rel="nofollow">
                     playbooks
                    </a>
                    so far, and the complexity is starting to bite. I am now going to start using
                    <a href="http://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html" rel="nofollow">
                     roles
                    </a>
                    as the recommended way to manage the complexity.
                   </p>
<h2>
<a name="TOC-References">
</a>
                    References
                   </h2>
<ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/index.html" rel="nofollow">
                      Ansible Documentation
                     </a>
</li>
<ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/playbooks.html" rel="nofollow">
                       Playbooks
                      </a>
</li>
<ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/playbooks_reuse_roles.html" rel="nofollow">
                        roles
                       </a>
</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/playbooks_blocks.html" rel="nofollow">
                        Blocks
                       </a>
</li>
</ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/playbooks_special_topics.html" rel="nofollow">
                       Playbooks: Special Topics
                      </a>
</li>
<ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/become.html" rel="nofollow">
                        Become (Privilege Escalation)
                       </a>
</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/playbooks_vault.html" rel="nofollow">
                        Using Vault in playbooks
                       </a>
</li>
</ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/modules_by_category.html" rel="nofollow">
                       Module Index
                      </a>
</li>
<ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/list_of_utilities_modules.html" rel="nofollow">
                        Utilities Modules
                       </a>
</li>
<ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/import_tasks_module.html" rel="nofollow">
                         import_tasks - import a task list.
                        </a>
</li>
</ul>
</ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/vault.html" rel="nofollow">
                       Ansible Vault
                      </a>
</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/command_line_tools.html" rel="nofollow">
                       Command Line Tools
                      </a>
</li>
<ul>
<li>
<a href="http://docs.ansible.com/ansible/latest/ansible-playbook.html" rel="nofollow">
                        ansible-playbook
                       </a>
</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/ansible-galaxy.html" rel="nofollow">
                        ansible-galaxy
                       </a>
</li>
<li>
<a href="http://docs.ansible.com/ansible/latest/ansible-vault.html" rel="nofollow">
                        ansible-vault
                       </a>
</li>
</ul>
</ul>
</ul>
<h2>
<a name="TOC-Design">
</a>
                    Design
                   </h2>
<h3>
<a name="TOC-Roles-Selected">
</a>
                    Roles Selected
                   </h3>
<p>
                    I am going to start with three (3) roles:
                   </p>
<table border="1">
<thead>
<tr>
<th>
                       Name
                      </th>
<th>
                       Description
                      </th>
<th>
                       Playbooks Used
                      </th>
</tr>
</thead>
<tbody>
<tr>
<td>
                       common
                      </td>
<td>
                       Ansible standard role
                      </td>
<td>
                       None
                      </td>
</tr>
<tr>
<td>
                       oracle_user
                      </td>
<td>
                       oracle user requirements: privileges; directories
                      </td>
<td>
<ul style="font-family:monospace">
<li>
                         install-dir.yml
                        </li>
<li>
                         oracle_software_src.yml
                        </li>
<li>
                         preinstall.yml
                        </li>
<li>
                         user_groups.yml
                        </li>
</ul>
</td>
</tr>
<tr>
<td>
                       oracle_gi
                      </td>
<td>
                       Everything needed to install Oracle Grid Infrastructure (GI)
                      </td>
<td>
<ul style="font-family:monospace">
<li>
                         gi_asm.yml
                        </li>
<li>
                         oracleasm_init_disk.yml
                        </li>
<li>
                         oracleasm.yml
                        </li>
</ul>
</td>
</tr>
</tbody>
</table>
<h2>
<a name="TOC-Procedure">
</a>
                    Procedure
                   </h2>
<h3>
<a name="TOC-Create-Roles">
</a>
                    Create Roles
                   </h3>
<p>
                    To create these roles, I run the following commands on
                    <a href="home/system-builds/auburn.html" style="font-family:monospace">
                     AUBURN
                    </a>
                    :
                   </p>
<pre style="background-color:lawngreen;border:5px groove black;margin-left:10px;padding:2px">cd /etc/ansible/roles
<a href="http://docs.ansible.com/ansible/latest/ansible-galaxy.html" rel="nofollow">ansible-galaxy</a> init common
<a href="http://docs.ansible.com/ansible/latest/ansible-galaxy.html" rel="nofollow">ansible-galaxy</a> init oracle_user
<a href="http://docs.ansible.com/ansible/latest/ansible-galaxy.html" rel="nofollow">ansible-galaxy</a> init oracle_gi
</pre>
<p>
                    The output is:
                   </p>
<pre style="background-color:aqua;border:5px groove black;margin-left:10px;padding:2px">douglas@auburn:/etc/ansible/roles$ ansible-galaxy init common
- common was created successfully
douglas@auburn:/etc/ansible/roles$ ansible-galaxy init oracle_user
- oracle_user was created successfully
douglas@auburn:/etc/ansible/roles$ ansible-galaxy init oracle_gi
- oracle_gi was created successfully
</pre>
<h3>
<a name="TOC-Playbook-for-Oracle-User-Role">
</a>
                    Playbook for Oracle User Role
                   </h3>
<p>
                    I created the main playbook for the
                    <span style="font-family:monospace">
                     oracle_user
                    </span>
                    role in
                    <span style="font-family:monospace">
                     /etc/ansible/roles/oracle_user/tasks/main.yml
                    </span>
                    with the following code:
                   </p>
<pre style="background-color:aqua;border:5px groove black;margin-left:10px;padding:2px">---
# tasks file for oracle_user
# =============================================================================
# (1) Creates the Oracle User through the Oracle pre-installation RPM
# (2) Creates the installation directories
# (3) Adds additional groups to the oracle user
# (4) Mounts software directory on NFS
# ==============================================================================

- name:             Set up ORACLE user
  block:
    - import_tasks: preinstall.yml
    - import_tasks: install_dir.yml
    - import_tasks: user_groups.yml
    - import_tasks: oracle_software_src.yml
  become:           yes
  become_user:      root
...
</pre>
<p>
                    Here I use the
                    <a href="http://docs.ansible.com/ansible/latest/playbooks_blocks.html" rel="nofollow">
                     block
                    </a>
                    to apply the
                    <a href="http://docs.ansible.com/ansible/latest/become.html" rel="nofollow">
                     privilege escalation
                    </a>
                    to all of the
                    <a href="http://docs.ansible.com/ansible/latest/import_tasks_module.html" rel="nofollow">
                     imported
                    </a>
                    tasks.
                   </p>
<h3>
<a name="TOC-Playbook-for-Oracle-GI-Role">
</a>
                    Playbook for Oracle GI Role
                   </h3>
<p>
                    I created the main playbook for the
                    <span style="font-family:monospace">
                     oracle_gi
                    </span>
                    role in
                    <span style="font-family:monospace">
                     /etc/ansible/roles/oracle_gi/tasks/main.yml
                    </span>
                    with the following code:
                   </p>
<pre style="background-color:aqua;border:5px groove black;margin-left:10px;padding:2px">---
# tasks file for oracle_gi
# =============================================================================
# (1) Install Oracle ASMLib Driver
# (2) Configure Oracle ASMLib Driver
# ==============================================================================

- name:		    Install and configure Oracle ASMLib driver
  block:
    - import_tasks: gi_asm.yml
    - import_tasks: oracleasm.yml
  become:           yes
  become_user:      root
...
</pre>
<p>
                    Here I use the
                    <a href="http://docs.ansible.com/ansible/latest/playbooks_blocks.html" rel="nofollow">
                     block
                    </a>
                    to apply the
                    <a href="http://docs.ansible.com/ansible/latest/become.html" rel="nofollow">
                     privilege escalation
                    </a>
                    to all of the
                    <a href="http://docs.ansible.com/ansible/latest/import_tasks_module.html" rel="nofollow">
                     imported
                    </a>
                    tasks.
                   </p>
<h3>
<a name="TOC-Main-Playbook">
</a>
                    Main Playbook
                   </h3>
<p>
                    I created the main playbook for the
                    <span style="font-family:monospace">
                     oracle_user
                    </span>
                    role in
                    <span style="font-family:monospace">
                     /etc/ansible/sites.yml
                    </span>
                    with the following code:
                   </p>
<pre style="background-color:aqua;border:5px groove black;margin-left:10px;padding:2px">---
- hosts:	redfern1.yaocm.id.au
  roles:
    - oracle_user
    - oracle_gi
...
</pre>
<p>
                    I did not include
                    <a href="http://docs.ansible.com/ansible/latest/become.html" rel="nofollow">
                     privilege escalation
                    </a>
                    here because some future tasks will have to run as the
                    <span style="font-family:monospace">
                     oracle
                    </span>
                    user.
                   </p>
<h3>
<a name="TOC-Execute-Main-Playbook">
</a>
                    Execute Main Playbook
                   </h3>
<p>
                    The complete playbook,
                    <span style="font-family:monospace">
                     sites.yml
                    </span>
                    , was executed as follows:
                   </p>
<pre style="background-color:lawngreen;border:5px groove black;margin-left:10px;padding:2px">ansible-playbook --ask-become-pass sites.yml
</pre>
<p>
                    The output was:
                   </p>
<pre style="border:5px groove black;margin-left:10px;padding:2px">SUDO password: 

PLAY [redfern1.yaocm.id.au] ****************************************************

TASK [Gathering Facts] *********************************************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_user : Install Oracle 12.1 pre-installation RPM] ******************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_user : Creating the Oracle Home and Oracle Base Directory] ********
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item=app/12.1.0/grid)</span>
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item=app/grid)</span>
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item=app/oracle)</span>

TASK [oracle_user : Add Oracle and Grid groups] ********************************
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item={u'gid': 54321, u'name': u'oinstall'})</span>
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item={u'gid': 54322, u'name': u'dba'})</span>
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item={u'gid': 54323, u'name': u'oper'})</span>
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item={u'gid': 54327, u'name': u'asmdba'})</span>
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item={u'gid': 54328, u'name': u'asmoper'})</span>
<span style="color:green">ok: [redfern1.yaocm.id.au] =&gt; (item={u'gid': 54329, u'name': u'asmadmin'})</span>

TASK [oracle_user : Set groups and password for Oracle user] *******************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_user : Install NFS Utilities Software] ****************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_user : Create Mount Point for Oracle Installation Software] *******
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_user : Mount NFS Share for Oracle Installation Software] **********
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Install Oracle ASMLib RPM] ***********************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Install other packages for ASM] ******************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Get Oracle ASMLib Driver Configuration] **********************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : debug] *******************************************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Set Owner for Oracle ASMLib Driver] **************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Set Group for Oracle ASMLib Driver] **************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Enable Oracle ASMLib Driver] *********************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Check Oracle ASMLib Driver Status] ***************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : debug] *******************************************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Load and initialize Oracle ASMLib Driver] ********************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Verify Oracle ASMLib Driver is loaded and initialized] *******
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : include_tasks] ***********************************************
<span style="color:aqua">included: /etc/ansible/roles/oracle_gi/tasks/oracleasm_init_disk.yml for redfern1.yaocm.id.au</span>
<span style="color:aqua">included: /etc/ansible/roles/oracle_gi/tasks/oracleasm_init_disk.yml for redfern1.yaocm.id.au</span>
<span style="color:aqua">included: /etc/ansible/roles/oracle_gi/tasks/oracleasm_init_disk.yml for redfern1.yaocm.id.au</span>
<span style="color:aqua">included: /etc/ansible/roles/oracle_gi/tasks/oracleasm_init_disk.yml for redfern1.yaocm.id.au</span>
<span style="color:aqua">included: /etc/ansible/roles/oracle_gi/tasks/oracleasm_init_disk.yml for redfern1.yaocm.id.au</span>

TASK [oracle_gi : Query status of disk "/dev/xvdd1"] ***************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : debug] *******************************************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Ensure that there is one partition that occupies whole disk "/dev/xvdd"] ***
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Initialize "/dev/xvdd1" as "DATA"] ***************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Query status of disk "/dev/xvde1"] ***************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : debug] *******************************************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Ensure that there is one partition that occupies whole disk "/dev/xvde"] ***
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Initialize "/dev/xvde1" as "FRA"] ****************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Query status of disk "/dev/xvdf1"] ***************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : debug] *******************************************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Ensure that there is one partition that occupies whole disk "/dev/xvdf"] ***
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Initialize "/dev/xvdf1" as "REDO1"] **************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Query status of disk "/dev/xvdg1"] ***************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : debug] *******************************************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Ensure that there is one partition that occupies whole disk "/dev/xvdg"] ***
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Initialize "/dev/xvdg1" as "REDO2"] **************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Query status of disk "/dev/xvdh1"] ***************************
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : debug] *******************************************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Ensure that there is one partition that occupies whole disk "/dev/xvdh"] ***
<span style="color:green">ok: [redfern1.yaocm.id.au]</span>

TASK [oracle_gi : Initialize "/dev/xvdh1" as "VOTE"] ***************************
<span style="color:aqua">skipping: [redfern1.yaocm.id.au]</span>

PLAY RECAP *********************************************************************
<span style="color:green">redfern1.yaocm.id.au</span>       : <span style="color:green">ok=28</span>   changed=0    unreachable=0    failed=0   

</pre>

</div>
<!-- {% endraw %} -->
